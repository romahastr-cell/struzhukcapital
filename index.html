<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>СТРАТЕГИЯ КАПИТАЛА — калькуляторы</title>
<style>
:root{
  --bg:#ffffff; --text:#0b1220; --muted:#475569; --border:#e5e7eb;
  --accent:#6D28D9; --accent-dark:#5a20b9;
}
*{box-sizing:border-box}
body{margin:0;background:#fff;color:var(--text);font:15px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}

/* HEADER (чёрный фон, белые тексты) */
header{position:sticky;top:0;z-index:10;background:#0b0b0e;color:#fff;border-bottom:1px solid #111}
.wrap-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 18px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{width:56px;height:56px;border-radius:10px;object-fit:cover}
.brand h1{margin:0;font-size:20px;color:#fff}
.author a{color:#fff;opacity:.9} .author a:hover{opacity:1}
.cta a{display:inline-block;padding:10px 14px;border:1px solid #ffffff33;border-radius:10px;background:#ffffff12;color:#fff;font-weight:700}

/* LAYOUT */
main{max-width:1200px;margin:20px auto;padding:0 16px}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.tab-btn{padding:10px 14px;border:2px solid var(--accent);border-radius:12px;background:#fff;color:var(--text);font-weight:800;cursor:pointer}
.tab-btn.active{background:var(--accent);color:#fff}
.card{background:#fff;border:2px solid var(--accent);border-radius:16px;padding:16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
label{display:block;margin:8px 0 6px;font-weight:700}
input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-size:15px}
input:focus,select:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(109,40,217,.1)}
.btn{padding:12px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
.btn:hover{background:var(--accent-dark)}
.btn.ghost{background:#fff;color:var(--text);border:2px solid var(--accent)}
.btn.tg{display:inline-flex;align-items:center;gap:8px}
.btn.tg svg{width:18px;height:18px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
.kpi{border:2px solid var(--accent);border-radius:16px;padding:12px;background:#fff}
.kpi .label{color:var(--muted);font-size:13px} .kpi .value{font-size:22px;font-weight:900}
.chart-wrap{margin-top:14px;border:2px solid var(--accent);border-radius:16px;padding:12px;background:#fff}
canvas{width:100% !important;height:360px !important;background:#fff;border:1px dashed var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:right;font-variant-numeric:tabular-nums}
th:first-child,td:first-child,th:nth-child(2),td:nth-child(2){text-align:left}
.section-title{font-weight:900;margin:4px 0 10px}
.tab{display:none} .tab.visible{display:block}
footer{margin:30px 0;padding:16px;border-top:1px solid var(--border)}
.footer-flex{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.footer-flex img.portrait{width:120px;height:120px;border-radius:12px;object-fit:cover}
.icon-link{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
.icon-link svg{width:20px;height:20px}
@media(max-width:1000px){.row,.row3{grid-template-columns:1fr} .grid4{grid-template-columns:1fr 1fr}}
/* маленький счётчик-баннер */
.ticker{margin:16px 0;padding:12px;border:2px dashed var(--accent);border-radius:12px;background:#faf5ff}
.ticker b{font-size:18px}
</style>
</head>
<body>
<header>
  <div class="wrap-header">
    <div class="brand">
      <img src="logo.jpg" alt="логотип">
      <div>
        <h1>СТРАТЕГИЯ КАПИТАЛА</h1>
        <div class="author"><a href="https://t.me/rstruzhuk" target="_blank">автор Roman Struzhuk · @rstruzhuk</a></div>
      </div>
    </div>
    <p class="cta"><a href="https://t.me/Struzhukcapital" target="_blank">Честный канал про стратегию капитала. Подпишись</a></p>
  </div>
</header>

<main>
  <!-- счётчик дохода пока смотришь сайт -->
  <div class="ticker">
    За время просмотра страницы ты бы уже заработал(а) <b id="liveProfit">0 ₽</b> при капитале 100 000 ₽ и доходности 50% годовых.
  </div>

  <!-- вкладки -->
  <div class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="pro">PRO</button>
    <button class="tab-btn" data-tab="light">LIGHT</button>
    <button class="tab-btn" data-tab="lose">Сколько теряешь</button>
    <button class="tab-btn" data-tab="goals">Цели</button>
    <button class="tab-btn" data-tab="need">Сколько вложить</button>
    <button class="tab-btn" data-tab="infl">Инфляция</button>
  </div>

  <!-- PRO -->
  <section class="tab visible" id="tab-pro">
    <div class="card">
      <div class="section-title">Параметры</div>
      <div class="row3">
        <div><label>Стартовый капитал</label><input id="pro_start" type="number" value="0" min="0" step="0.01" inputmode="decimal"></div>
        <div><label>Ежемесячный взнос</label><input id="pro_monthly" type="number" value="100000" min="0" step="0.01" inputmode="decimal"></div>
        <div><label>Срок, лет</label><input id="pro_years" type="number" value="10" min="1" max="60" step="1" inputmode="numeric"></div>
      </div>
      <div class="row">
        <div>
          <label>Тип годовой ставки</label>
          <select id="pro_annual_type"><option value="nominal" selected>Номинальная</option><option value="effective">Эффективная</option></select>
          <div class="muted">Номинальная — указанная годовая без учёта периода начисления. Эффективная — реальная годовая с учётом капитализации.</div>
        </div>
        <div><label>Годовая ставка, %</label><input id="pro_annual" type="number" value="50" step="0.0001" inputmode="decimal"></div>
      </div>
      <div class="row">
        <div>
          <label>Капитализация</label>
          <select id="pro_comp"><option value="monthly" selected>Ежемесячно</option><option value="daily">Ежедневно</option></select>
          <div class="muted">Ежемесячная — проценты раз в месяц. Ежедневная — каждый день, эффект сильнее.</div>
        </div>
        <div>
          <label>Реинвестирование</label>
          <select id="pro_reinv"><option value="yes" selected>проценты в капитал</option><option value="no">проценты выводить</option></select>
          <div class="muted">Реинвест — проценты добавляются к капиталу.</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="pro_run">Рассчитать</button>
        <button class="btn ghost" id="pro_csv">Экспорт CSV</button>
        <button class="btn tg" id="pro_share">
          <!-- иконка телеги -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13" stroke-width="2"/><path d="M22 2l-7 20-4-9-9-4 20-7z" stroke-width="2"/></svg>
          Поделиться в Telegram
        </button>
      </div>
    </div>

    <div class="grid4">
      <div class="kpi"><div class="label">Баланс к концу периода</div><div id="pro_final" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Всего внесено</div><div id="pro_deposits" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Получено процентов</div><div id="pro_interest" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Эффективная годовая</div><div id="pro_effapr" class="value">0%</div></div>
    </div>

    <div class="chart-wrap">
      <div class="section-title">Итоги по годам (свечи)</div>
      <canvas id="pro_year_chart" width="1000" height="360"></canvas>
    </div>

    <div class="chart-wrap">
      <div class="section-title">Сравнение стратегий (линии)</div>
      <canvas id="compare_chart" width="1000" height="360"></canvas>
      <div class="muted" style="margin-top:8px;">По умолчанию: депозит 12% годовых, рынок 10% годовых, стратегия 50% годовых. Параметры можно менять во вкладке PRO.</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="section-title">Помесячная таблица</div>
      <div style="max-height:420px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
        <table id="pro_table">
          <thead><tr><th>#</th><th>Период</th><th>Взнос, ₽</th><th>Проценты за период, ₽</th><th>Баланс, ₽</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- LIGHT (ежедневные проценты) -->
  <section class="tab" id="tab-light">
    <div class="card">
      <div class="section-title">Калькулятор ежедневных сложных процентов</div>
      <div class="row3">
        <div><label>Начальное значение, ₽</label><input id="light_initial" type="number" value="100000" min="0" step="0.01" inputmode="decimal"></div>
        <div>
          <label>Процентная ставка</label>
          <div class="row">
            <input id="light_rate" type="number" value="1" step="0.0001" inputmode="decimal">
            <select id="light_unit"><option value="daily" selected>% в день</option><option value="monthly">% в месяц</option><option value="annual">% в год</option></select>
          </div>
        </div>
        <div><label>Время, дней</label><input id="light_days" type="number" value="365" min="1" step="1" inputmode="numeric"></div>
      </div>
      <div style="margin-top:10px;"><button class="btn" id="light_run">Рассчитать</button></div>
    </div>

    <div class="grid4">
      <div class="kpi"><div class="label">Расчет ваших инвестиций</div><div id="light_future" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Общая сумма процентов</div><div id="light_interest" class="value">0 ₽</div></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="section-title">Баланс по дням</div>
      <div style="max-height:420px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
        <table id="light_table">
          <thead><tr><th>День</th><th>Баланс, ₽</th><th>Заработанные проценты, ₽</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Сколько теряешь -->
  <section class="tab" id="tab-lose">
    <div class="card">
      <div class="section-title">Сколько ты теряешь</div>
      <div class="row3">
        <div><label>Сумма, ₽</label><input id="lose_amount" type="number" value="100000" min="0" step="0.01"></div>
        <div><label>Срок, лет</label><input id="lose_years" type="number" value="5" min="1" step="1"></div>
        <div><label>Депозит, % годовых</label><input id="lose_bank" type="number" value="12" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Стратегия, % годовых</label><input id="lose_strategy" type="number" value="50" step="0.01"></div>
        <div><label>Инфляция, % годовых</label><input id="lose_infl" type="number" value="8" step="0.01"></div>
      </div>
      <div style="margin-top:10px;"><button class="btn" id="lose_run">Посчитать разницу</button></div>
    </div>
    <div class="grid4">
      <div class="kpi"><div class="label">Итог по депозиту</div><div id="lose_bank_val" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Итог по стратегии</div><div id="lose_strat_val" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Разница</div><div id="lose_diff" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Реально (с учётом инфляции)</div><div id="lose_real" class="value">0 ₽</div></div>
    </div>
    <div class="chart-wrap">
      <div class="section-title">График по годам</div>
      <canvas id="lose_chart" width="1000" height="360"></canvas>
    </div>
  </section>

  <!-- Цели -->
  <section class="tab" id="tab-goals">
    <div class="card">
      <div class="section-title">Цель: сколько нужно вносить ежемесячно</div>
      <div class="row3">
        <div><label>Цель, ₽</label><input id="goal_target" type="number" value="1000000" min="1" step="1"></div>
        <div><label>Срок, лет</label><input id="goal_years" type="number" value="5" min="1" step="1"></div>
        <div><label>Годовая ставка, %</label><input id="goal_rate" type="number" value="50" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Стартовый капитал, ₽</label><input id="goal_start" type="number" value="0" min="0" step="0.01"></div>
        <div><label>Тип ставки</label><select id="goal_type"><option value="effective" selected>Эффективная</option><option value="nominal">Номинальная</option></select></div>
      </div>
      <div style="margin-top:10px;"><button class="btn" id="goal_run">Рассчитать взнос</button></div>
    </div>
    <div class="grid4">
      <div class="kpi"><div class="label">Необходимый ежемесячный взнос</div><div id="goal_monthly" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Всего внесёшь</div><div id="goal_total_in" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Доля реинвеста (оценка)</div><div id="goal_interest_share" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Годовая эффективная</div><div id="goal_eff" class="value">0%</div></div>
    </div>
  </section>

  <!-- Сколько вложить -->
  <section class="tab" id="tab-need">
    <div class="card">
      <div class="section-title">Сколько нужно вложить сегодня</div>
      <div class="row3">
        <div><label>Цель, ₽</label><input id="need_target" type="number" value="3000000" min="1" step="1"></div>
        <div><label>Срок, лет</label><input id="need_years" type="number" value="5" min="1" step="1"></div>
        <div><label>Годовая ставка, %</label><input id="need_rate" type="number" value="50" step="0.01"></div>
      </div>
      <div class="row">
        <div><label>Ежемесячный взнос, ₽</label><input id="need_monthly" type="number" value="0" min="0" step="0.01"></div>
        <div><label>Тип ставки</label><select id="need_type"><option value="effective" selected>Эффективная</option><option value="nominal">Номинальная</option></select></div>
      </div>
      <div style="margin-top:10px;"><button class="btn" id="need_run">Рассчитать стартовый капитал</button></div>
    </div>
    <div class="grid4">
      <div class="kpi"><div class="label">Необходимый стартовый капитал</div><div id="need_start" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Всего внесёшь</div><div id="need_total_in" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Доля реинвеста (оценка)</div><div id="need_interest_share" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Годовая эффективная</div><div id="need_eff" class="value">0%</div></div>
    </div>
  </section>

  <!-- Инфляция -->
  <section class="tab" id="tab-infl">
    <div class="card">
      <div class="section-title">Инфляция и покупательная способность</div>
      <div class="row3">
        <div><label>Сумма сегодня, ₽</label><input id="infl_amount" type="number" value="100000" min="0" step="0.01"></div>
        <div><label>Срок, лет</label><input id="infl_years" type="number" value="5" min="1" step="1"></div>
        <div><label>Инфляция, % годовых</label><input id="infl_rate" type="number" value="8" step="0.01"></div>
      </div>
      <div style="margin-top:10px;"><button class="btn" id="infl_run">Посчитать</button></div>
    </div>
    <div class="grid4">
      <div class="kpi"><div class="label">Будущая номинальная сумма</div><div id="infl_future" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Покупательная способность (сегодняшними)</div><div id="infl_real" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Потеря покупательной способности</div><div id="infl_loss" class="value">0 ₽</div></div>
      <div class="kpi"><div class="label">Комментарий</div><div id="infl_note" class="value">—</div></div>
    </div>
  </section>

  <!-- Мотивационный блок -->
  <div class="card" style="margin-top:16px;">
    <div class="section-title">Если бы ты инвестировал(а) 100 000 ₽ 5 лет назад под 50% годовых…</div>
    <div id="motivation" style="font-weight:800;font-size:18px;">Считаем…</div>
  </div>
</main>

<footer>
  <div class="footer-flex">
    <img class="portrait" src="roman.jpg" alt="Roman Struzhuk">
    <a class="icon-link" href="https://instagram.com/rstruzhuk" target="_blank" title="Instagram">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="5" ry="5" stroke-width="2"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" stroke-width="2"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke-width="2"/></svg>
      <span>@rstruzhuk</span>
    </a>
    <a class="icon-link" href="https://t.me/Struzhukcapital" target="_blank" title="Стратегия капитала">
      <img src="logo.jpg" alt="СК" style="width:20px;height:20px;border-radius:4px;object-fit:cover;">
      <span>Канал «Стратегия капитала»</span>
    </a>
    <a class="icon-link" href="https://t.me/rstruzhuk" target="_blank" title="Telegram">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13" stroke-width="2"/><path d="M22 2l-7 20-4-9-9-4 20-7z" stroke-width="2"/></svg>
      <span>@rstruzhuk</span>
    </a>
  </div>
</footer>

<script>
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>{ const num=Number(n); if(!isFinite(num)) return '0'; try{return num.toLocaleString('ru-RU',{maximumFractionDigits:2});}catch(e){return String(Math.round(num*100)/100).replace(/\B(?=(\d{3})+(?!\d))/g,' ');} };

/* вкладки */
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('visible'));
    document.getElementById('tab-'+b.dataset.tab).classList.add('visible');
  });
});

/* расчёт ставок */
function monthlyFromAPR(apr, type){
  const r = apr/100;
  if(type==='effective') return Math.pow(1+r,1/12)-1;
  return r/12; // nominal
}
function dailyFromAPR(apr, type){
  const r = apr/100;
  if(type==='effective') return Math.pow(1+r,1/365)-1;
  return r/365;
}

/* PRO симуляция */
function proSimulate(){
  const start = parseFloat(($('pro_start').value||'0').replace(',','.'));
  const P = parseFloat(($('pro_monthly').value||'0').replace(',','.'));
  const years = Math.max(1, parseInt($('pro_years').value||'10',10));
  const type = $('pro_annual_type').value;
  const apr = parseFloat(($('pro_annual').value||'0').replace(',','.'));
  const comp = $('pro_comp').value;
  const reinv = $('pro_reinv').value==='yes';

  const rM = monthlyFromAPR(apr, type);
  const rD = dailyFromAPR(apr, type);

  let capital = start, interestPayout = 0, totalDeposits = start;
  const startDate = new Date(); startDate.setHours(0,0,0,0); startDate.setDate(1);
  const endDate = new Date(startDate); endDate.setFullYear(endDate.getFullYear()+years);

  const rows=[]; let idx=0; const yearLabels=[]; const yearData=[];
  function pushRow(label, dep, intr, bal){ rows.push({idx:++idx,label,deposit:dep||0,interest:intr||0,balance:bal||0}); }

  if(comp==='monthly'){
    let d = new Date(startDate);
    while(d<endDate){
      const label = new Date(d.getFullYear(), d.getMonth(), 1).toLocaleDateString('ru-RU',{year:'numeric',month:'2-digit'});
      // взнос в начале месяца
      capital += P; totalDeposits += P;
      const intr = capital * (isFinite(rM)?rM:0);
      if(reinv) capital += intr; else interestPayout += intr;
      pushRow(label, P, intr, capital);
      const next = new Date(d.getFullYear(), d.getMonth()+1, 1);
      if(next.getFullYear()!==d.getFullYear()){ yearLabels.push(String(d.getFullYear())); yearData.push(capital); }
      d = next;
    }
  }else{
    let d=new Date(startDate); let month=d.getMonth(); let intr=0, dep=0;
    while(d<endDate){
      if(d.getDate()===1){ capital += P; totalDeposits += P; dep += P; }
      const i = capital * (isFinite(rD)?rD:0);
      if(reinv) capital += i; else interestPayout += i;
      intr += i;
      const next=new Date(d); next.setDate(d.getDate()+1);
      if(next.getMonth()!==month){
        const label=new Date(d.getFullYear(), d.getMonth(), 1).toLocaleDateString('ru-RU',{year:'numeric',month:'2-digit'});
        pushRow(label, dep, intr, capital); dep=0; intr=0;
        if(next.getFullYear()!==d.getFullYear()){ yearLabels.push(String(d.getFullYear())); yearData.push(capital); }
        month=next.getMonth();
      }
      d=next;
    }
  }

  // KPI
  const finalSum=capital, totDep=totalDeposits, totInt= reinv ? (finalSum - totDep) : interestPayout;
  $('pro_final').textContent = fmt(finalSum)+' ₽';
  $('pro_deposits').textContent = fmt(totDep)+' ₽';
  $('pro_interest').textContent = fmt(totInt)+' ₽';
  $('pro_effapr').textContent = ((Math.pow(1 + (isFinite(rM)?rM:0), 12) - 1)*100).toFixed(2) + '%';

  // таблица
  const tbody=document.querySelector('#pro_table tbody'); tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+r.idx+'</td><td>'+r.label+'</td><td>'+fmt(r.deposit)+'</td><td>'+fmt(r.interest)+'</td><td>'+fmt(r.balance)+'</td>';
    tbody.appendChild(tr);
  });

  drawYearBars('pro_year_chart', yearLabels, yearData);

  // сравнение стратегий (12% депозит, 10% рынок, стратегия apr)
  drawCompare('compare_chart', years, apr, 12, 10, start, P, type);
}

/* свечи */
function drawYearBars(id, labels, data){
  const c=$(id), ctx=c.getContext('2d'), W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const pad=40, x0=pad, y0=H-pad, x1=W-pad, y1=20;
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y1); ctx.lineTo(x1,y1); ctx.stroke();
  if(!data.length) return;
  const max=Math.max(...data)*1.1 || 1; const n=data.length; const bw=(x1-x0)/(n*1.4); const gap=bw*0.4;
  ctx.fillStyle='#64748b'; ctx.font='12px Inter,system-ui,sans-serif';
  for(let i=0;i<=5;i++){ const t=i/5; const y=y0-(y0-y1)*t; const val=max*t; ctx.strokeStyle='rgba(2,6,23,.08)'; ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke(); ctx.fillText(fmt(val),4,y+4); }
  for(let i=0;i<n;i++){ const v=data[i]; const x=x0+i*(bw+gap)+gap; const h=(v/max)*(y0-y1); const y=y0-h;
    ctx.fillStyle='#6D28D933'; ctx.strokeStyle='#6D28D9'; ctx.lineWidth=2;
    ctx.fillRect(x,y,bw,h); ctx.strokeRect(x,y,bw,h);
    ctx.fillStyle='#0b1220'; ctx.textAlign='center';
    ctx.fillText(fmt(v)+' ₽', x+bw/2, y-6);
    ctx.fillText(labels[i], x+bw/2, y0+14);
    ctx.textAlign='start';
  }
}

/* сравнение стратегий — простая линия по годам (месячная капитализация) */
function futureWithMonthly(start, monthly, years, apr, type){
  const rM = monthlyFromAPR(apr, type);
  let cap = start;
  for(let y=0; y<years; y++){
    for(let m=0;m<12;m++){
      cap += monthly;
      cap += cap * rM;
    }
  }
  return cap;
}
function drawCompare(id, years, aprStrat, aprBank, aprMarket, start, monthly, type){
  const labels=Array.from({length:years},(_,i)=>String(new Date().getFullYear()+i));
  const strat=[], bank=[], market=[];
  let cs=start, cb=start, cm=start;
  const rMs = monthlyFromAPR(aprStrat, type), rMb = monthlyFromAPR(aprBank,'effective'), rMm = monthlyFromAPR(aprMarket,'effective');

  for(let y=0;y<years;y++){
    for(let m=0;m<12;m++){
      cs += monthly; cs += cs*rMs;
      cb += monthly; cb += cb*rMb;
      cm += monthly; cm += cm*rMm;
    }
    strat.push(cs); bank.push(cb); market.push(cm);
  }

  const c=$(id), ctx=c.getContext('2d'), W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const pad=40, x0=pad, y0=H-pad, x1=W-pad, y1=20;
  const max=Math.max(...strat, ...bank, ...market)*1.1||1;

  // grid
  ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y1); ctx.lineTo(x1,y1); ctx.stroke();
  ctx.fillStyle='#64748b'; ctx.font='12px Inter,system-ui,sans-serif';
  for(let i=0;i<=5;i++){ const t=i/5; const y=y0-(y0-y1)*t; const val=max*t; ctx.strokeStyle='rgba(2,6,23,.08)'; ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke(); ctx.fillText(fmt(val),4,y+4); }

  function plot(arr, color){
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
    arr.forEach((v,i)=>{
      const x=x0 + (x1-x0)* (i/(arr.length-1||1));
      const y=y0 - (v/max)*(y0-y1);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  plot(bank, '#9ca3af'); // серый — депозит
  plot(market, '#2563eb'); // синий — рынок
  plot(strat, '#6D28D9'); // фиолет — стратегия

  // подписи по оси X
  ctx.fillStyle='#0b1220'; ctx.textAlign='center';
  labels.forEach((lab,i)=>{
    const x=x0 + (x1-x0)* (i/(labels.length-1||1));
    ctx.fillText(lab, x, y0+14);
  });
}

/* экспорт CSV из PRO */
function proExportCSV(){
  const rows=[...document.querySelectorAll('#pro_table tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  const header=['#','Период','Взнос, ₽','Проценты за период, ₽','Баланс, ₽'];
  const blob=new Blob([[header.join(';')].concat(rows.map(r=>r.join(';'))).join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='strategy_capital_pro.csv'; a.click(); URL.revokeObjectURL(url);
}

/* share в Telegram */
function proShare(){
  const text = `Мой расчёт по «Стратегии капитала»:\nИтог: ${$('pro_final').textContent}\nВнесено: ${$('pro_deposits').textContent}\nПроценты: ${$('pro_interest').textContent}\nПопробуй сам: https://t.me/Struzhukcapital`;
  const url = 'https://t.me/share/url?url='+encodeURIComponent('https://t.me/Struzhukcapital')+'&text='+encodeURIComponent(text);
  window.open(url,'_blank');
}

/* LIGHT */
function toDailyRate(value, unit){
  const r = parseFloat(String(value).replace(',','.'))/100;
  if (!isFinite(r) || r<0) return 0;
  if (unit==='daily') return r;
  if (unit==='monthly') return Math.pow(1+r, 1/30)-1;
  if (unit==='annual') return Math.pow(1+r, 1/365)-1;
  return 0;
}
function lightRun(){
  const P = parseFloat(($('light_initial').value||'0').replace(',','.'));
  const rate = parseFloat(($('light_rate').value||'0').replace(',','.'));
  const unit = $('light_unit').value;
  const days = Math.max(1, parseInt($('light_days').value||'1',10));
  const rD = toDailyRate(rate, unit);

  let balance = P, totalInterest = 0;
  const tbody = document.querySelector('#light_table tbody'); tbody.innerHTML='';
  let tr0=document.createElement('tr'); tr0.innerHTML='<td>1</td><td>'+fmt(balance)+'</td><td>0</td>'; tbody.appendChild(tr0);
  for (let d=2; d<=days; d++){
    const interest = balance * rD;
    balance += interest; totalInterest += interest;
    const tr=document.createElement('tr'); tr.innerHTML = '<td>'+d+'</td><td>'+fmt(balance)+'</td><td>'+fmt(interest)+'</td>'; tbody.appendChild(tr);
  }
  $('light_future').textContent = fmt(balance) + ' ₽';
  $('light_interest').textContent = fmt(totalInterest) + ' ₽';
}

/* Сколько теряешь */
function loseRun(){
  const A = parseFloat(($('lose_amount').value||'0').replace(',','.'));
  const Y = Math.max(1, parseInt($('lose_years').value||'1',10));
  const bank = parseFloat(($('lose_bank').value||'0').replace(',','.'));
  const strat = parseFloat(($('lose_strategy').value||'0').replace(',','.'));
  const infl = parseFloat(($('lose_infl').value||'0').replace(',','.'));

  function fv(a,r,y){ return a*Math.pow(1+r/100,y); }

  const bankVal = fv(A, bank, Y);
  const stratVal = fv(A, strat, Y);
  const diff = stratVal - bankVal;
  const real = stratVal / Math.pow(1+infl/100, Y);

  $('lose_bank_val').textContent = fmt(bankVal)+' ₽';
  $('lose_strat_val').textContent = fmt(stratVal)+' ₽';
  $('lose_diff').textContent = fmt(diff)+' ₽';
  $('lose_real').textContent = fmt(real)+' ₽';

  // график
  const years = Array.from({length:Y+1},(_,i)=>i);
  const arrBank = years.map(i=>fv(A,bank,i));
  const arrStr = years.map(i=>fv(A,strat,i));
  drawLines('lose_chart', years.map(i=>String(i)), [arrBank, arrStr], ['Депозит','Стратегия'], ['#9ca3af','#6D28D9']);
}
function drawLines(id, labels, series, names, colors){
  const c=$(id), ctx=c.getContext('2d'), W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const pad=40, x0=pad, y0=H-pad, x1=W-pad, y1=20;
  const max = Math.max(...series.flat())*1.1 || 1;
  ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y1); ctx.lineTo(x1,y1); ctx.stroke();
  ctx.fillStyle='#64748b'; ctx.font='12px Inter,system-ui,sans-serif';
  for(let i=0;i<=5;i++){ const t=i/5; const y=y0-(y0-y1)*t; const val=max*t; ctx.strokeStyle='rgba(2,6,23,.08)'; ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke(); ctx.fillText(fmt(val),4,y+4); }
  function plot(arr, color){
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
    arr.forEach((v,i)=>{
      const x=x0 + (x1-x0)*(i/((arr.length-1)||1));
      const y=y0 - (v/max)*(y0-y1);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  series.forEach((arr,i)=>plot(arr, colors[i]||'#000'));
  // X labels
  ctx.fillStyle='#0b1220'; ctx.textAlign='center';
  labels.forEach((lab,i)=>{ const x=x0 + (x1-x0)*(i/((labels.length-1)||1)); ctx.fillText(lab, x, y0+14); });
}

/* Цели — нужный ежемесячный взнос при заданной цели */
function goalRun(){
  const T = parseFloat(($('goal_target').value||'0').replace(',','.'));
  const Y = Math.max(1, parseInt($('goal_years').value||'1',10));
  const r = parseFloat(($('goal_rate').value||'0').replace(',','.'));
  const S0 = parseFloat(($('goal_start').value||'0').replace(',','.'));
  const type = $('goal_type').value;

  const n = Y*12;
  const i = monthlyFromAPR(r, type); // месячная ставка
  // FV = S0*(1+i)^n + P * [((1+i)^n - 1)/i]
  // => P = (FV - S0*(1+i)^n) * i / ((1+i)^n - 1)
  const pow = Math.pow(1+i, n);
  const numerator = (T - S0*pow) * i;
  const denom = (pow - 1);
  const P = denom>0 ? Math.max(0, numerator/denom) : 0;

  $('goal_monthly').textContent = fmt(P)+' ₽';
  $('goal_total_in').textContent = fmt(P*n + S0)+' ₽';
  $('goal_interest_share').textContent = fmt(Math.max(0, T - (P*n + S0)))+' ₽';
  $('goal_eff').textContent = ((Math.pow(1+i,12) - 1)*100).toFixed(2)+'%';
}

/* Сколько вложить — требуемый старт при заданном ежемесячном взносе */
function needRun(){
  const T = parseFloat(($('need_target').value||'0').replace(',','.'));
  const Y = Math.max(1, parseInt($('need_years').value||'1',10));
  const r = parseFloat(($('need_rate').value||'0').replace(',','.'));
  const P = parseFloat(($('need_monthly').value||'0').replace(',','.'));
  const type = $('need_type').value;

  const n = Y*12;
  const i = monthlyFromAPR(r,type);
  const pow = Math.pow(1+i, n);
  // T = S0*pow + P * ((pow-1)/i)  => S0 = (T - P*((pow-1)/i))/pow
  const ann = i>0 ? (pow-1)/i : n;
  const S0 = (T - P*ann)/pow;

  $('need_start').textContent = fmt(Math.max(0,S0))+' ₽';
  $('need_total_in').textContent = fmt(P*n + Math.max(0,S0))+' ₽';
  $('need_interest_share').textContent = fmt(Math.max(0, T - (P*n + Math.max(0,S0))))+' ₽';
  $('need_eff').textContent = ((Math.pow(1+i,12) - 1)*100).toFixed(2)+'%';
}

/* Инфляция */
function inflRun(){
  const A = parseFloat(($('infl_amount').value||'0').replace(',','.'));
  const Y = Math.max(1, parseInt($('infl_years').value||'1',10));
  const R = parseFloat(($('infl_rate').value||'0').replace(',','.'));
  const real = A / Math.pow(1+R/100, Y);
  $('infl_future').textContent = fmt(A)+' ₽';
  $('infl_real').textContent = fmt(real)+' ₽';
  $('infl_loss').textContent = fmt(Math.max(0, A-real))+' ₽';
  $('infl_note').textContent = `Через ${Y} лет купить получится на сумму, эквивалентную сегодняшним ${fmt(real)} ₽ при инфляции ${R}%`;
}

/* мотивационный блок */
function updateMotivation(){
  const P0 = 100000, years = 5, apr = 50;
  const eff = Math.pow(1+apr/100, years);
  const val = P0*eff;
  $('motivation').textContent = `Сегодня это было бы ${fmt(val)} ₽ (без пополнений).`;
}

/* live-триггер дохода при 50% APR от 100 000 ₽ */
function startTicker(){
  const base = 100000;
  const apr = 50; // эффективная годовая
  const perSec = Math.pow(1+apr/100, 1/(365*24*3600)) - 1;
  let t0 = performance.now();
  let acc = 0;
  function step(ts){
    const dt = (ts - t0)/1000; t0 = ts;
    acc += base * (Math.pow(1+perSec, dt) - 1);
    $('liveProfit').textContent = fmt(acc)+' ₽';
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* wire */
$('pro_run').addEventListener('click', proSimulate);
$('pro_csv').addEventListener('click', proExportCSV);
$('pro_share').addEventListener('click', proShare);

$('light_run').addEventListener('click', lightRun);
$('lose_run').addEventListener('click', loseRun);
$('goal_run').addEventListener('click', goalRun);
$('need_run').addEventListener('click', needRun);
$('infl_run').addEventListener('click', inflRun);

/* первый запуск */
proSimulate();
lightRun();
loseRun();
goalRun();
needRun();
inflRun();
updateMotivation();
startTicker();
</script>
</body>
</html>
